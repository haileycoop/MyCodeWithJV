# Multiplayer approach

## Inputs from Luis

**Broader understanding of multiplayer systems**
I had an initial chat with Luis about how to go about this:

- To properly run multiplayer, I need a persistent service to manage game state
- Luis likened it to an app like Discord that is on my computer and always running and doing things, and therefore can persistently hold a state
- He distinguished this from services like netlify and cloud functions which are all about being stateless
- All of of these things open connections but stateless services try to close them again soon to save costs
- My app will need to be divided up between the client side and the server side
- The client side is the same for every user and can be static / stateless and so can be stored on a service like netlify
- The server, with an app like colyseus running on it, needs to be perisstent because it needs to be stateful
- I also have to write game logic code that lives on that server to manage game state
- The principle here is that you want the server to be authoritative in terms of what the game state is, so all the clients are being synced from one place
- There is no hard and fast rule about where the boundary is drawn
- In the example of a die: User A clicks on the die to roll it. This input is read in the client, but is sent to the server. The client could start the roll animation, but the server should generate the result, and send it back to client A, as well as clients B, C, and D.

**First multiplayer learning experiemnt**

- Colysesus seems good enough to try
- Initially just try running it locally and getting the code working from there
- When I want to deploy the app properly, there are more choices to make
- Luis is a fan of docker / kubernetes since we are moving environments around to different places now
- I could maybe install the colyseus on bluehost, or maybe on AWS since I have some credits

## Implementing Colyseus in phaser-test dev local

I asked the AI to tell me what to do. I pasted it's response but will also edit it to reflect what actually happened.

---

To start implementing Colyseus in your local development environment, follow these detailed steps:

### Step 1: Install System Requirements\*\*

- This was basics like npm, git, VScode...

### Step 2: Set Up Colyseus Server Project\*\*

1. Open your terminal or command prompt.
2. Navigate to the root folder of your project "phaser-test" using the `cd` command. For example: cd /path/to/phaser-test
3. Run the following command to create a new Colyseus server project:
   npm create colyseus-app@latest ./server

This command will create a new Colyseus server project in a directory named "server" within your "phaser-test" project folder. It will automatically install the necessary dependencies and set up the project structure for you.

Notes

- It set up a server folder with many sub-folders and files
- I noticed that the server has its own separate package.json and .env files
- This is similar to my previous firebase attempt, but I was trying to learn that all at once
- I think this must be the right approach because in talking to Luis, I'm pretty sure he said that the server folder is often tucked into the app's file structure
- So when developing locally, I will need to go into the server folder and start the server
- Do I need to implement vite separately for the server?

Results - how to run the local server

- when it's time to start the server:
- navigate to ./server in a new terminal
- run `npm start` and it will spin up locally

### Step 3: Connect to the Colyseus Server

To connect to the server from the client-side, you will need to use one of the available client-side SDKs provided by Colyseus. Follow the documentation of the specific SDK you choose to learn how to connect and interact with the server.

Notes

- I was able to do this by working with the AI to add colyseus code to main.ts
- I focused on resolving all of the IDE errors first
- then I focused on the warnings
- this led me to a place where I could get the app working and logging
- but it became clear that the app was not fully wired up and that I needed to start modifying the code
- this eventually led me to a place that I now realise is step 4

### Step 4: Implement Room Definition

In Colyseus, a Room is a game session that clients can join or create. You need to implement your own Room definition to handle your game sessions. This involves managing the game state, handling client connections and disconnections, and processing messages between the client and server.

Refer to the Colyseus documentation or tutorials to learn more about implementing Room definitions and handling game sessions.

Notes:

- After feeding the AI lots of documentation and the templates that were created when I installed colyseus, I was able to get it to make a list of changes that I would need to make to get my current game working as multiplayer
- I think some of these steps bleed into later steps of the current plan, so I will keep an eye on this as I go **<= LOOK HERE FIRST**
- Here is the current list, which I will work through and update as needed

#### Wiring up multiplayer between client and server

To change the current behavior in main.ts into a multiplayer game using the server-side files, you need to perform the following steps:

##### Import the necessary server-side files and configure the server-side environment.

- I believe this is done but I will probably find out stuff as I go that still needs doing

##### Update the server-side MyRoom class to handle multiplayer game logic.

- HERE: This is where I am leaving off **<= THEN FOCUS EFFORT HERE**

a. Implement game state management using @colyseus/schema to define the synchronized state of the room.

b. Modify the onCreate method to initialize the game state and define message handlers for game events.

c. Update the onJoin and onLeave methods to handle player connections and disconnections.

d. Implement game-specific logic within the message handlers to update the game state based on player actions.

e. Add any additional methods or callbacks required for the game mechanics.

##### Modify the server-side app.config.ts file to import and define the MyRoom class.

##### Customize the MyRoomState schema in MyRoomState.ts to reflect the game's data structure and state.

##### Update the client-side main.ts to connect to the Colyseus server, join or create a room, and handle room events.

a. Update the import statements to include the necessary Colyseus and Phaser libraries.

b. Modify the connection URL in the Client constructor to match the server's address.

c. Handle room events such as state changes, receiving messages from the server, errors, and client disconnections.

d. Pass the Colyseus room instance to the GameScene constructor and store it as a property.

##### Update the GameScene class in the client-side main.ts to integrate with the multiplayer functionality.

a. Store the Colyseus room instance as a property within the GameScene class.

b. Modify the create method to handle game initialization and setup.

c. Implement event handlers or listeners for player actions, such as dragging objects, and communicate these actions to the server through the Colyseus room instance.

d. Update the update method to reflect the synchronized game state received from the server.

##### Customize the remaining Phaser game code and assets as needed for your specific multiplayer game.

Remember to adapt the code and steps to match your game's requirements and design.

### Step 5: Exchange Messages Between Client and Server

To enable real-time communication between the client and server, you need to exchange messages. This allows clients to send inputs or actions to the server and receive updates or events from the server. Colyseus provides mechanisms for sending and receiving messages between the client and server, and you can define your own message formats and protocols.

Consult the Colyseus documentation for details on how to exchange messages between the client and server.

### Step 6: Understand State Synchronization

Colyseus offers automatic state synchronization between the server and connected clients. This means that the server's game state is automatically synchronized with the clients, ensuring consistency across all connected players. You should familiarize yourself with how state synchronization works in Colyseus to ensure your multiplayer game operates as expected.

Refer to the Colyseus documentation or tutorials for a deeper understanding of state synchronization in Colyseus.

### Step 7: Experiment, Play, and Have Fun!

Now that you have set up your Colyseus server project and learned the basics, it's time to experiment, play, and have fun! Start developing your multiplayer game using Colyseus, test it locally, and iterate on your design and features. Don't be afraid to try new ideas and learn from the process.
